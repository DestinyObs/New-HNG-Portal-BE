name: CI for Staging

on:
  pull_request:
    branches:
      - staging
  workflow_dispatch:
    inputs:
      run_seed:
        description: 'Run database seeding? (yes/no)'
        required: false
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  code-quality:
    name: Code Quality & Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, json
          coverage: none
          
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-
          
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Run PHPStan (Larastan)
        # continue-on-error: true
        run: ./vendor/bin/phpstan analyse --memory-limit=2G

      - name: Check code style (Laravel Pint)
        # continue-on-error: true
        run: |
          if [ -f "./vendor/bin/pint" ]; then
            ./vendor/bin/pint --test
          else
            echo "Pint not installed, skipping..."
          fi

  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none
          
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-
          
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Composer security audit
        id: composer_audit
        # continue-on-error: true
        run: |
          composer audit --format=json > audit.json || true
          cat audit.json

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.29.0
        # continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        # continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

  tests:
    name: Feature & Unit Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, json, pdo, pdo_mysql
          coverage: xdebug
          
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-
          
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Copy .env.testing
        run: cp .env.example .env.testing

      - name: Set test environment variables
        run: |
          echo "DB_CONNECTION=mysql" >> .env.testing
          echo "DB_HOST=127.0.0.1" >> .env.testing
          echo "DB_PORT=3306" >> .env.testing
          echo "DB_DATABASE=testing_db" >> .env.testing
          echo "DB_USERNAME=root" >> .env.testing
          echo "DB_PASSWORD=root" >> .env.testing
          echo "APP_KEY=base64:$(openssl rand -base64 32)" >> .env.testing
          echo "GOOGLE_CLIENT_ID=fake-google-client-id" >> .env.testing
          echo "GOOGLE_CLIENT_SECRET=fake-google-client-secret" >> .env.testing
          echo "GOOGLE_REDIRECT_URI=http://localhost/auth/google/callback" >> .env.testing

      - name: Run migrations
        run: php artisan migrate --env=testing --force

      - name: Seed database
        if: ${{ github.event.inputs.run_seed == 'yes' }}
        run: php artisan db:seed --env=testing --force

      - name: Run PHPUnit tests with coverage
        id: phpunit
        run: |
          ./vendor/bin/phpunit --stop-on-failure --coverage-text --coverage-clover=coverage.xml | tee phpunit.log
          
          # Check if tests failed
          if grep -q "ERRORS!" phpunit.log || grep -q "FAILURES!" phpunit.log; then
            echo "Tests failed! See errors above."
            exit 1
          fi

      - name: Extract test results
        if: always()
        id: test_results
        run: |
          TESTS_RUN=$(grep -oP 'Tests: \K\d+' phpunit.log | head -1 || echo "0")
          ASSERTIONS=$(grep -oP 'Assertions: \K\d+' phpunit.log | head -1 || echo "0")
          FAILURES=$(grep -oP 'Failures: \K\d+' phpunit.log | head -1 || echo "0")
          ERRORS=$(grep -oP 'Errors: \K\d+' phpunit.log | head -1 || echo "0")
          COVERAGE=$(grep 'Lines:' phpunit.log | grep -oP '\d+\.\d+%' | head -1 || echo "N/A")
          
          echo "tests_run=$TESTS_RUN" >> $GITHUB_OUTPUT
          echo "assertions=$ASSERTIONS" >> $GITHUB_OUTPUT
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

  final-status:
    name: CI Pipeline Status
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, tests]
    if: always()
    
    steps:
      - name: Check all jobs status
        id: check_status
        run: |
          if [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "${{ needs.security-scan.result }}" == "success" ] && \
             [ "${{ needs.tests.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=All CI checks passed successfully!" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Some CI checks failed. Please review the results." >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack - Final CI Status
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.DEPLOY_NOTIFY_WEBHOOK_URL }}
        run: |
          if [ "${{ steps.check_status.outputs.status }}" == "success" ]; then
            COLOR="good"
            SUMMARY="All CI checks passed! Ready to merge."
          else
            COLOR="danger"
            SUMMARY="CI pipeline failed. Review required before merging."
          fi
          
          # Build detailed status
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            QUALITY_STATUS="PASSED: PHPStan + Pint"
          else
            QUALITY_STATUS="FAILED: Static analysis issues"
          fi
          
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            SECURITY_STATUS="PASSED: Trivy + Composer Audit clean"
          else
            SECURITY_STATUS="FAILED: Vulnerabilities detected"
          fi
          
          if [ "${{ needs.tests.result }}" == "success" ]; then
            TEST_STATUS="PASSED: All tests successful"
          else
            TEST_STATUS="FAILED: Test failures detected"
          fi
          
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "attachments": [{
                "color": "'"$COLOR"'",
                "title": "[HNG Portal BE] CI Pipeline Complete - Staging",
                "text": "'"$SUMMARY"'",
                "fields": [
                  {"title": "Repository", "value": "HNG Portal Backend", "short": true},
                  {"title": "Overall Status", "value": "'"${{ steps.check_status.outputs.status }}"'", "short": true},
                  {"title": "Code Quality (PHPStan + Pint)", "value": "'"$QUALITY_STATUS"'", "short": false},
                  {"title": "Security Scan (Trivy + Audit)", "value": "'"$SECURITY_STATUS"'", "short": false},
                  {"title": "Tests (PHPUnit)", "value": "'"$TEST_STATUS"'", "short": false},
                  {"title": "Branch", "value": "'"${{ github.head_ref }}"'", "short": true},
                  {"title": "Author", "value": "'"${{ github.actor }}"'", "short": true},
                  {"title": "PR", "value": "<'"${{ github.event.pull_request.html_url }}"'|#'"${{ github.event.pull_request.number }}"'>", "short": true},
                  {"title": "Commit", "value": "'"${GITHUB_SHA:0:7}"'", "short": true},
                  {"title": "View Details", "value": "<'"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"'|Full Workflow Run>", "short": false}
                ],
                "footer": "HNG Portal Backend - Staging CI",
                "ts": '"$(date +%s)"'
              }]
            }'
          fi
