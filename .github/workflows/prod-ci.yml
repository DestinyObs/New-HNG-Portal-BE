name: CI for Production

on:
  pull_request:
    branches:
      - prod

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  code-quality:
    name: Code Quality & Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, json
          coverage: none
          
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-
          
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Run PHPStan (Larastan)
        # continue-on-error: true
        run: ./vendor/bin/phpstan analyse --memory-limit=2G

      - name: Check code style (Laravel Pint)
        # continue-on-error: true
        run: |
          if [ -f "./vendor/bin/pint" ]; then
            ./vendor/bin/pint --test
          else
            echo "Pint not installed, skipping..."
          fi

      - name: Notify Slack - Code Quality
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.DEPLOY_NOTIFY_WEBHOOK_URL }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            COLOR="good"
            EMOJI=":white_check_mark:"
            STATUS="Passed"
          else
            COLOR="warning"
            EMOJI=":warning:"
            STATUS="Completed with warnings"
          fi
          
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d '{
            "attachments": [{
              "color": "'$COLOR'",
              "title": "'$EMOJI' Production CI - Code Quality",
              "fields": [
                {"title": "Environment", "value": "Production", "short": true},
                {"title": "Status", "value": "'$STATUS'", "short": true},
                {"title": "Branch", "value": "'"${{ github.head_ref }}"'", "short": true},
                {"title": "Author", "value": "'"${{ github.actor }}"'", "short": true},
                {"title": "Commit", "value": "'"${GITHUB_SHA:0:7}"'", "short": true},
                {"title": "PR", "value": "<'"${{ github.event.pull_request.html_url }}"'|#'"${{ github.event.pull_request.number }}"'>", "short": true}
              ],
              "footer": "GitHub Actions",
              "ts": '$(date +%s)'
            }]
          }'
          fi

  security-scan:
    name: Security & Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none
          
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-
          
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Composer security audit
        id: composer_audit
        # continue-on-error: true
        run: |
          composer audit --format=json > audit.json || true
          cat audit.json

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.29.0
        # continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Notify Slack - Security Scan
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.DEPLOY_NOTIFY_WEBHOOK_URL }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            COLOR="good"
            EMOJI=":shield:"
            STATUS="No vulnerabilities found"
          elif [ "${{ job.status }}" == "failure" ]; then
            COLOR="danger"
            EMOJI=":rotating_light:"
            STATUS="Vulnerabilities detected!"
          else
            COLOR="warning"
            EMOJI=":warning:"
            STATUS="Scan completed with warnings"
          fi
          
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d '{
            "attachments": [{
              "color": "'$COLOR'",
              "title": "'$EMOJI' Production CI - Security Scan",
              "fields": [
                {"title": "Environment", "value": "Production", "short": true},
                {"title": "Status", "value": "'$STATUS'", "short": true},
                {"title": "Branch", "value": "'"${{ github.head_ref }}"'", "short": true},
                {"title": "Author", "value": "'"${{ github.actor }}"'", "short": true},
                {"title": "Trivy", "value": "Scanned for CRITICAL & HIGH", "short": true},
                {"title": "Composer Audit", "value": "Dependency check completed", "short": true}
              ],
              "footer": "GitHub Actions",
              "ts": '$(date +%s)'
            }]
          }'
          fi

  tests:
    name: Feature & Unit Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, json, pdo, pdo_mysql
          coverage: xdebug
          
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-
          
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Copy .env.testing
        run: cp .env.example .env.testing

      - name: Set test environment variables
        run: |
          echo "DB_CONNECTION=mysql" >> .env.testing
          echo "DB_HOST=127.0.0.1" >> .env.testing
          echo "DB_PORT=3306" >> .env.testing
          echo "DB_DATABASE=test_db" >> .env.testing
          echo "DB_USERNAME=root" >> .env.testing
          echo "DB_PASSWORD=root" >> .env.testing
          echo "APP_KEY=base64:$(openssl rand -base64 32)" >> .env.testing
          echo "GOOGLE_CLIENT_ID=fake-google-client-id" >> .env.testing
          echo "GOOGLE_CLIENT_SECRET=fake-google-client-secret" >> .env.testing
          echo "GOOGLE_REDIRECT_URI=http://localhost/auth/google/callback" >> .env.testing

      - name: Run migrations
        run: php artisan migrate --env=testing --force

      - name: Seed database
        # continue-on-error: true
        run: php artisan db:seed --env=testing --force

      - name: Run PHPUnit tests with coverage
        id: phpunit
        run: |
          ./vendor/bin/phpunit --stop-on-failure --coverage-text --coverage-clover=coverage.xml | tee phpunit.log
          
          # Check if tests failed
          if grep -q "ERRORS!" phpunit.log || grep -q "FAILURES!" phpunit.log; then
            echo "Tests failed! See errors above."
            exit 1
          fi

      - name: Extract test results
        if: always()
        id: test_results
        run: |
          TESTS_RUN=$(grep -oP 'Tests: \K\d+' phpunit.log | head -1 || echo "0")
          ASSERTIONS=$(grep -oP 'Assertions: \K\d+' phpunit.log | head -1 || echo "0")
          FAILURES=$(grep -oP 'Failures: \K\d+' phpunit.log | head -1 || echo "0")
          ERRORS=$(grep -oP 'Errors: \K\d+' phpunit.log | head -1 || echo "0")
          COVERAGE=$(grep 'Lines:' phpunit.log | grep -oP '\d+\.\d+%' | head -1 || echo "N/A")
          
          echo "tests_run=$TESTS_RUN" >> $GITHUB_OUTPUT
          echo "assertions=$ASSERTIONS" >> $GITHUB_OUTPUT
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Notify Slack - Test Results
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.DEPLOY_NOTIFY_WEBHOOK_URL }}
        run: |
          if [ "${{ steps.phpunit.outcome }}" == "success" ]; then
            COLOR="good"
            EMOJI=":test_tube:"
            STATUS="All tests passed!"
          else
            COLOR="danger"
            EMOJI=":x:"
            STATUS="Tests failed!"
          fi
          
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d '{
            "attachments": [{
              "color": "'$COLOR'",
              "title": "'$EMOJI' Production CI - Test Results",
              "fields": [
                {"title": "Environment", "value": "Production", "short": true},
                {"title": "Status", "value": "'$STATUS'", "short": true},
                {"title": "Tests Run", "value": "'"${{ steps.test_results.outputs.tests_run }}"'", "short": true},
                {"title": "Assertions", "value": "'"${{ steps.test_results.outputs.assertions }}"'", "short": true},
                {"title": "Failures", "value": "'"${{ steps.test_results.outputs.failures }}"'", "short": true},
                {"title": "Errors", "value": "'"${{ steps.test_results.outputs.errors }}"'", "short": true},
                {"title": "Coverage", "value": "'"${{ steps.test_results.outputs.coverage }}"'", "short": true},
                {"title": "Branch", "value": "'"${{ github.head_ref }}"'", "short": true},
                {"title": "Author", "value": "'"${{ github.actor }}"'", "short": false},
                {"title": "PR Link", "value": "<'"${{ github.event.pull_request.html_url }}"'|View Pull Request #'"${{ github.event.pull_request.number }}"'>", "short": false}
              ],
              "footer": "GitHub Actions",
              "ts": '$(date +%s)'
            }]
          }'
          fi

  final-status:
    name: CI Pipeline Status
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, tests]
    if: always()
    
    steps:
      - name: Check all jobs status
        id: check_status
        run: |
          if [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "${{ needs.security-scan.result }}" == "success" ] && \
             [ "${{ needs.tests.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=All CI checks passed successfully!" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Some CI checks failed. Please review the results." >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack - Final CI Status
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.DEPLOY_NOTIFY_WEBHOOK_URL }}
        run: |
          if [ "${{ steps.check_status.outputs.status }}" == "success" ]; then
            COLOR="good"
            EMOJI=":rocket:"
          else
            COLOR="danger"
            EMOJI=":no_entry:"
          fi
          
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d '{
            "attachments": [{
              "color": "'$COLOR'",
              "title": "'$EMOJI' Production CI Pipeline - Final Status",
              "text": "'"${{ steps.check_status.outputs.message }}"'",
              "fields": [
                {"title": "Environment", "value": "Production", "short": true},
                {"title": "Overall Status", "value": "'"${{ steps.check_status.outputs.status }}"'", "short": true},
                {"title": "Code Quality", "value": "'"${{ needs.code-quality.result }}"'", "short": true},
                {"title": "Security Scan", "value": "'"${{ needs.security-scan.result }}"'", "short": true},
                {"title": "Tests", "value": "'"${{ needs.tests.result }}"'", "short": true},
                {"title": "Branch", "value": "'"${{ github.head_ref }}"'", "short": true},
                {"title": "Author", "value": "'"${{ github.actor }}"'", "short": true},
                {"title": "Triggered By", "value": "PR to prod branch", "short": true},
                {"title": "View Details", "value": "<'"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"'|GitHub Actions Run>", "short": false}
              ],
              "footer": "HNG Portal Backend CI",
              "ts": '$(date +%s)'
            }]
          }'
    




# name: CI for Production

# on:
#   pull_request:
#     branches:
#       - prod

# permissions:
#   contents: read
#   pull-requests: write

# jobs:
#   checks:
#     # runs-on: [self-hosted, hng-13-runner, linux]
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout source code
#         uses: actions/checkout@v4

#       - name: Set up PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.3'
          
#       - name: Install Composer dependencies
#         # This installs all dependencies, including larastan/phpstan from composer.json
#         run: composer install --no-interaction --prefer-dist

#       # - name: PHPStan static analysis (Larastan)
#       #   run: ./vendor/bin/phpstan analyse --level=max app
      
#       - name: Composer security audit
#         run: composer audit --format=json || true

#       # - name: Run PHPUnit tests
#       #   run: ./vendor/bin/phpunit
    


