name: Deploy Laravel Backend to Production

on:
  push:
    branches:
      - prod

permissions:
  contents: read

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Notify Slack - Deployment Started
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.DEPLOY_NOTIFY_WEBHOOK_URL }}
        run: |
          curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d '{
            "attachments": [{
              "color": "#ff9900",
              "title": ":warning: Production Deployment Started",
              "fields": [
                {"title": "Environment", "value": "PRODUCTION", "short": true},
                {"title": "Status", "value": "In Progress", "short": true},
                {"title": "Branch", "value": "'"${{ github.ref_name }}"'", "short": true},
                {"title": "Trigger", "value": "'"${{ github.event_name }}"'", "short": true},
                {"title": "Triggered By", "value": "'"${{ github.actor }}"'", "short": true},
                {"title": "Commit", "value": "'"${GITHUB_SHA:0:7}"'", "short": true}
              ],
              "footer": "HNG Portal Production Deployment",
              "ts": '$(date +%s)'
            }]
          }'
      
      - name: Setup SSH private key for secure server access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Prepare Known Hosts
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
        run: |
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Git Operations on Remote
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
          SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
          APP_DIR: ${{ secrets.DEPLOY_PROD_APP_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 "$SERVER_USER@$SERVER_HOST" "cd $APP_DIR && git fetch origin && git reset --hard origin/prod && git clean -fd"

      - name: Install Composer Dependencies
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
          SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
          APP_DIR: ${{ secrets.DEPLOY_PROD_APP_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 "$SERVER_USER@$SERVER_HOST" "cd $APP_DIR && /usr/local/bin/composer install --prefer-dist --no-interaction --optimize-autoloader"

      - name: Laravel Cache and Optimize
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
          SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
          APP_DIR: ${{ secrets.DEPLOY_PROD_APP_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 "$SERVER_USER@$SERVER_HOST" "cd $APP_DIR && php artisan config:clear && php artisan config:cache && php artisan route:cache && php artisan view:cache && php artisan optimize"

      - name: Run Migrations
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
          SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
          APP_DIR: ${{ secrets.DEPLOY_PROD_APP_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 "$SERVER_USER@$SERVER_HOST" "cd $APP_DIR && php artisan migrate --force"

      - name: Restart Backend Service
        id: restart_service
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
          SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
          APP_DIR: ${{ secrets.DEPLOY_PROD_APP_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 "$SERVER_USER@$SERVER_HOST" "bash -s" << ENDSSH
            set -e
            echo "üîÑ Restarting production backend service..."
            sudo systemctl daemon-reload
            sudo systemctl restart prod-backend
            sleep 3
            
            if systemctl is-active --quiet prod-backend; then
              echo "‚úÖ Production backend service is running"
              sudo systemctl status prod-backend --no-pager
            else
              echo "‚ùå Production backend service failed to start"
              sudo systemctl status prod-backend --no-pager
              exit 1
            fi
          ENDSSH

      - name: Deployment Summary
        if: always()
        id: deployment_status
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Production deployment completed successfully!" >> $GITHUB_OUTPUT
            echo "‚úÖ Production deployment completed successfully!"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Production deployment failed. Immediate attention required!" >> $GITHUB_OUTPUT
            echo "‚ùå Production deployment failed!"
            exit 1
          fi

      - name: Notify Slack - Deployment Complete
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.DEPLOY_NOTIFY_WEBHOOK_URL }}
        run: |
          if [ "${{ steps.deployment_status.outputs.status }}" == "success" ]; then
            COLOR="good"
            EMOJI=":tada:"
            STATUS="Success"
            MESSAGE="Production deployment completed successfully! :rocket:"
          else
            COLOR="danger"
            EMOJI=":fire:"
            STATUS="Failed"
            MESSAGE="@channel PRODUCTION DEPLOYMENT FAILED! Immediate attention required!"
          fi
          
          curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "'"$MESSAGE"'",
            "attachments": [{
              "color": "'$COLOR'",
              "title": "'$EMOJI' Production Deployment Complete",
              "text": "'"${{ steps.deployment_status.outputs.message }}"'",
              "fields": [
                {"title": "Environment", "value": "PRODUCTION :red_circle:", "short": true},
                {"title": "Status", "value": "'$STATUS'", "short": true},
                {"title": "Branch", "value": "'"${{ github.ref_name }}"'", "short": true},
                {"title": "Trigger", "value": "'"${{ github.event_name }}"'", "short": true},
                {"title": "Deployed By", "value": "'"${{ github.actor }}"'", "short": true},
                {"title": "Commit", "value": "<'"${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"'|'"${GITHUB_SHA:0:7}"'>", "short": true},
                {"title": "Workflow Run", "value": "<'"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"'|View Details>", "short": false}
              ],
              "footer": "HNG Portal Production Deployment System",
              "ts": '$(date +%s)'
            }]
          }'  
