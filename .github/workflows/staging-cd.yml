


name: Deploy Laravel Backend to Staging

on:
  push:
    branches:
      - staging
      
  workflow_dispatch:
    inputs:
      fresh_seed:
        description: 'Run migrate:fresh and seed? (yes/no)'
        required: false
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'

permissions:
  contents: read

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deployment Started
        run: |
          echo "ðŸš€ Starting deployment to staging..."
          echo "Fresh seed: ${{ github.event.inputs.fresh_seed || 'no' }}"
      
      - name: Install sshpass
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y sshpass

      - name: Prepare SSH
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy Application (Standard Migration)
        if: ${{ github.event.inputs.fresh_seed != 'yes' }}
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
          SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
          APP_DIR: ${{ secrets.DEPLOY_STAGING_APP_DIR }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "bash -s" << ENDSSH
            set -e
            cd "$APP_DIR"
            
            echo "ðŸ“¦ Pulling latest code..."
            git fetch origin
            git reset --hard origin/staging
            git clean -fd
            
            echo "ðŸ“š Installing dependencies..."
            /usr/local/bin/composer install --prefer-dist --no-interaction --optimize-autoloader --no-dev
            
            echo "ðŸ§¹ Clearing caches..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            
            echo "ðŸ”„ Running migrations..."
            php artisan migrate --force
            
            echo "âš¡ Optimizing application..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize
            
            echo "âœ… Standard deployment completed"
          ENDSSH

      - name: Deploy Application (Fresh Migration + Seed)
        if: ${{ github.event.inputs.fresh_seed == 'yes' }}
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
          SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
          APP_DIR: ${{ secrets.DEPLOY_STAGING_APP_DIR }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "bash -s" << ENDSSH
            set -e
            cd "$APP_DIR"
            
            echo "ðŸ“¦ Pulling latest code..."
            git fetch origin
            git reset --hard origin/staging
            git clean -fd
            
            echo "ðŸ“š Installing dependencies..."
            /usr/local/bin/composer install --prefer-dist --no-interaction --optimize-autoloader --no-dev
            
            echo "ðŸ§¹ Clearing caches..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            
            echo "âš ï¸  WARNING: Running migrate:fresh + seed (DATABASE WILL BE WIPED)"
            php artisan migrate:fresh --force
            php artisan db:seed --force
            
            echo "âš¡ Optimizing application..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize
            
            echo "âœ… Fresh migration + seed completed"
          ENDSSH

      - name: Restart Backend Service
        env:
          SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
          SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "bash -s" << ENDSSH
            set -e
            echo "ðŸ”„ Restarting backend service..."
            sudo systemctl daemon-reload
            sudo systemctl restart staging-backend
            sleep 3
            
            if systemctl is-active --quiet staging-backend; then
              echo "âœ… Backend service is running"
              sudo systemctl status staging-backend --no-pager
            else
              echo "âŒ Backend service failed to start"
              sudo systemctl status staging-backend --no-pager
              exit 1
            fi
          ENDSSH

      - name: Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to staging completed successfully!"
            echo "Fresh seed: ${{ github.event.inputs.fresh_seed || 'no' }}"
          else
            echo "âŒ Deployment failed. Check logs above."
            exit 1
          fi





# name: Deploy Laravel Backend to Staging

# on:
#   push:
#     branches:
#       - staging

# permissions:
#   contents: read
#   pull-requests: write

# jobs:
#   build-deploy:
#     # runs-on: [self-hosted, hng-13-runner, linux]
#     runs-on: ubuntu-latest
#     steps:
#       - name: Install sshpass
#         run: |
#           sudo apt-get update || true
#           sudo apt-get install -y sshpass || true

#       - name: Prepare SSH and Known Hosts
#         env:
#           SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
#         run: |
#           mkdir -p ~/.ssh
#           chmod 700 ~/.ssh
#           ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

#       - name: Git Operations on Remote
#         env:
#           SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
#           SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
#           SERVER_PASSWORD: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
#           APP_DIR: ${{ secrets.DEPLOY_STAGING_APP_DIR }}
#         run: |
#           sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "cd $APP_DIR && git fetch origin && git reset --hard origin/staging && git clean -fd"

#       - name: Install Composer Dependencies
#         env:
#           SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
#           SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
#           SERVER_PASSWORD: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
#           APP_DIR: ${{ secrets.DEPLOY_STAGING_APP_DIR }}
#         run: |
#           sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "cd $APP_DIR && /usr/local/bin/composer install --prefer-dist --no-interaction --optimize-autoloader"

#       - name: Laravel Cache and Optimize
#         env:
#           SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
#           SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
#           SERVER_PASSWORD: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
#           APP_DIR: ${{ secrets.DEPLOY_STAGING_APP_DIR }}
#         run: |
#           sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "cd $APP_DIR && php artisan config:clear && php artisan config:cache && php artisan route:cache && php artisan view:cache && php artisan optimize"

#       - name: Run Migrations
#         env:
#           SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
#           SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
#           SERVER_PASSWORD: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
#           APP_DIR: ${{ secrets.DEPLOY_STAGING_APP_DIR }}
#         run: |
#           sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "cd $APP_DIR && php artisan migrate:fresh --force && php artisan db:seed --force"

#       - name: Restart Backend Service
#         env:
#           SERVER_HOST: ${{ secrets.DEPLOY_SERVER_IP }}
#           SERVER_USER: ${{ secrets.DEPLOY_SERVER_USER }}
#           SERVER_PASSWORD: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
#         run: |
#           sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "sudo systemctl daemon-reload && sudo systemctl restart staging-backend && sudo systemctl status staging-backend --no-pager"

#       - name: Notify Deployment Status
#         if: always()
#         run: echo "Staging deployment finished."
